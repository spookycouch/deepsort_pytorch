from __future__ import print_function

import os
import numpy as np

from skimage import io
import matplotlib
matplotlib.use('TkAgg')
import matplotlib.pyplot as plt
import matplotlib.patches as patches

import glob
import time
import argparse

from deepsort import DeepSort


def parse_args():
  """Parse input arguments."""
  parser = argparse.ArgumentParser(description='SORT demo')
  parser.add_argument('--display', dest='display', help='Display online tracker output (slow) [False]',action='store_true')
  parser.add_argument("--seq_path", help="Path to detections.", type=str, default='data')
  parser.add_argument("--phase", help="Subdirectory in seq_path.", type=str, default='train')
  args = parser.parse_args()
  return args

# all train
args = parse_args()
display = args.display
phase = args.phase
total_time = 0.0
total_frames = 0
colours = np.random.rand(32, 3) #used only for display

if(display):
  if not os.path.exists('mot_benchmark'):
    print('\n\tERROR: mot_benchmark link not found!\n\n    Create a symbolic link to the MOT benchmark\n    (https://motchallenge.net/data/2D_MOT_2015/#download). E.g.:\n\n    $ ln -s /path/to/MOT2015_challenge/2DMOT2015 mot_benchmark\n\n')
    exit()
  plt.ion()
  fig = plt.figure()
  ax1 = fig.add_subplot(111, aspect='equal')

if not os.path.exists('output'):
  os.makedirs('output')
pattern = os.path.join(args.seq_path, phase, '*', 'det', 'det.txt')
for seq_dets_fn in glob.glob(pattern):
  mot_tracker = DeepSort() #create instance of the SORT tracker
  seq_dets = np.loadtxt(seq_dets_fn, delimiter=',')
  seq = seq_dets_fn[pattern.find('*'):].split('/')[0]
  
  with open('output/%s.txt'%(seq),'w') as out_file:
    print("Processing %s."%(seq))
    for frame in range(int(seq_dets[:,0].max())):
      frame += 1 #detection and frame numbers begin at 1
      dets = seq_dets[seq_dets[:, 0]==frame, 2:7]
      dets[:, 2:4] += dets[:, 0:2] #convert to [x1,y1,w,h] to [x1,y1,x2,y2]
      total_frames += 1

      fn = 'mot_benchmark/%s/%s/img1/%06d.jpg'%(phase, seq, frame)
      im =io.imread(fn)
      im = np.flip(im, axis=2)

      if(display):

        ax1.imshow(im)
        plt.title(seq + ' Tracked Targets')

      start_time = time.time()
      trackers = mot_tracker.update(im, dets)
      cycle_time = time.time() - start_time
      total_time += cycle_time

      for d in trackers:
        print('%d,%d,%.2f,%.2f,%.2f,%.2f,1,-1,-1,-1'%(frame,d[4],d[0],d[1],d[2]-d[0],d[3]-d[1]),file=out_file)
        if(display):
          d = d.astype(np.int32)
          ax1.add_patch(patches.Rectangle((d[0],d[1]),d[2]-d[0],d[3]-d[1],fill=False,lw=3,ec=colours[d[4]%32,:]))

      if(display):
        fig.canvas.flush_events()
        plt.draw()
        ax1.cla()

print("Total Tracking took: %.3f seconds for %d frames or %.1f FPS" % (total_time, total_frames, total_frames / total_time))

if(display):
  print("Note: to get real runtime results run without the option: --display")